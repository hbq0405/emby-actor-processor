# D:/vue/docker/docker-compose.yml (最终持久化版)

version: '3.8'

services:
  emby-toolkit:
    build: .
    container_name: emby-toolkit
    restart: unless-stopped
    volumes:
      - ./local_data:/config
      - /var/run/docker.sock:/var/run/docker.sock:rw
    environment:
      - APP_DATA_DIR=/config
      - PUID=1000
      - PGID=1000
      - CONTAINER_NAME=emby-toolkit
      - DOCKER_IMAGE_NAME=emby-toolkit
    user: "1000:999"  # 用户ID:docker组ID，确保有访问docker.sock的权限
    ports:
      - "5257:5257"
    networks:
      - emby-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5257/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  nginx:
    image: nginx:1.25-alpine
    container_name: emby-proxy-nginx
    restart: unless-stopped
    ports:
      - "8097:8097"
    volumes:
      - ./local_data/nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      emby-toolkit:
        condition: service_healthy
    networks:
      - emby-net

networks:
  emby-net:
    driver: bridge